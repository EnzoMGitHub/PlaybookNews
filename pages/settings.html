<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="/styles.css" />
    <style>
        html, body {
            background-image: none !important;
            background-color: black; 
        }

        #selector {
            border: 1px solid white;
            border-radius: 10px;
            padding: 16px;
        }

        #options {
            border: 1px solid white;
            border-radius: 10px;
            padding: 16px;
        }

        /* Remove native bevel/highlight on this button */
        .stbtn {
            font-size: 22px;
            padding-bottom: 10px;
            background-color: transparent;
            color: white;
            -webkit-appearance: none;
            appearance: none;
            box-shadow: none !important;
            border: 1px solid transparent;
            outline: none;
            width: 100%;
        }

        .stbtn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        #AFC {
            border-color: red;
            border-radius: 10px;
            border-style: solid;
            margin-right: 2px;
        }

        #NFC {
            border-color: blue;
            border-radius: 10px;
            border-style: solid;
            margin-left: 2px;
            
        }

        .team-list label{
            display: block;
            padding: 4px 0;
            font-size: 1rem;
        }
    </style>
    <title>PlaybookNews</title>
  </head>
  <body>
    <!-- Navigation bar -->
    <div>
      <nav id="nav">
        <ul>
          <li><b>PlaybookNews</b></li>
          <li><a href="./">Home</a></li>
          <li><a href="/dashboard" class="log" id="change1">Dashboard</a></li>
          <li><a href="#" class="log" id="change2">News</a></li>
          <li><a href="#" class="log" id="change3">Teams</a></li>
          <li><a href="#" class="log">Players</a></li>
          <li><a href="#" class="log">Schedule</a></li>
          <li><a href="#" class="log">Stats</a></li>
          <li class="drop" id="user-dropdown" style="display:none">
            <button type="button" class="drop-btn log" id="user-btn">
              <span id="user"></span>
            </button>
            <ul class="drop-menu" id="user-menu">
              <li><a href="/settings">Settings</a></li>
              <li><a href="/logout">Logout</a></li>
            </ul>
          </li>
        </ul>
      </nav>
    </div>
    <main class="container py-5">
        <h1 class="text-center mb-4"><b>Settings</b></h1>
        <div class="row g-4">
        <!--Selector Div-->
            <div class="col-md-4">
            <div class="p-4 h-100" id="selector" style="border: 1px solid white; border-radius: 10px;">
                <button class="mb-0 stbtn" id="prof" type="button">User Profile</button>
                <button class="mb-0 stbtn" id="team">Change Team</button>
                <button class="mb-0 stbtn" id="person">Personalization</button>
                <button class="mb-0 stbtn" id="logout"> Logout</button>
            </div>
        </div>
        <!--Option pages stacked in one column-->
        <div class="col-md-8 position-relative">
            <!--Option Div-->
          <div class="p-4 h-100 d-none option-pane" id="options" style="border: 1px solid white; border-radius: 10px;">
                <form class="mt-4" id="options-form">
                    <div class="row g-3 align-items-center">
                        <label for="optionUsername" class="col-lg-2 col-form-label">Username</label>
                        <div class="col-lg-9">
                            <input type="text" class="form-control" id="optionUsername" required>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button type="submit" id="optnBtn" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
            <!--Team Div-->
            <div class="p-4 h-100 d-none option-pane" id="teamDiv" style="border: 1px solid white; border-radius: 10px;">
                <form class="mt-4" id='altTeam' action="/preferences" method="post">
                    <div class="row justify-content-center">
                        <div class="col-12" id="AFC" style="width:95%; margin:0 auto 12px;">
                            <!-- AFC content -->
                            <h3><b>American Football Conference</b></h3>
                            <div>
                                <h4>AFC East</h4>
                                <ul class="team-list">
                                <label><input type="radio" class="form-check-input me-2" name="team" value="Buffalo Bills" id="team-bills"> Buffalo Bills</label>
                                <label><input type="radio" class="form-check-input me-2" name="team" value="Miami Dolphins" id="team-dolphins"> Miami Dolphins</label>
                                <label><input type="radio" class="form-check-input me-2" name="team" value="New England Patriots" id="team-patriots"> New England Patriots</label>
                                <label><input type="radio" class="form-check-input me-2" name="team" value="New York Jets" id="team-jets"> New York Jets</label>
                                </ul>
                            </div>

                            <div>
                                <h4>AFC North</h4>
                                <ul class="team-list">
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Baltimore Ravens" id="team-ravens"> Baltimore Ravens</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Cincinnati Bengals" id="team-bengals"> Cincinnati Bengals</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Cleveland Browns" id="team-browns"> Cleveland Browns</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Pittsburgh Steelers" id="team-steelers"> Pittsburgh Steelers</label>
                                </ul>
                            </div>

                            <div>
                                <h4>AFC South</h4>
                                <ul class="team-list">
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Houston Texans" id="team-texans"> Houston Texans</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Indianapolis Colts" id="team-colts"> Indianapolis Colts</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Jacksonville Jaguars" id="team-jaguars"> Jacksonville Jaguars</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Tennessee Titans" id="team-titans"> Tennessee Titans</label>
                                </ul>
                            </div>

                            <div>
                                <h4>AFC West</h4>
                                <ul class="team-list">
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Kansas City Chiefs" id="team-chiefs"> Kansas City Chiefs</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Denver Broncos" id="team-broncos"> Denver Broncos</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Las Vegas Raiders" id="team-raiders"> Las Vegas Raiders</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Los Angeles Chargers" id="team-chargers"> Los Angeles Chargers</label>
                                </ul>
                            </div>
                        </div>
                        <div class="col-12" id="NFC" style="width:95%; margin:0 auto;">
                            <!-- NFC content -->
                            <h3><b>National Football Conference</b></h3>
                            <div>
                                <h4>NFC East</h4>
                                <ul class="team-list">
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Philadelphia Eagles" id="team-eagles"> Philadelphia Eagles</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Dallas Cowboys" id="team-cowboys"> Dallas Cowboys</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Washington Commanders" id="team-commanders"> Washington Commanders</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="New York Giants" id="team-giants"> New York Giants</label>
                                </ul>
                            </div>

                                <div>
                                <h4>NFC North</h4>
                                <ul class="team-list">
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Green Bay Packers" id="team-packers"> Green Bay Packers</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Minnesota Vikings" id="team-vikings"> Minnesota Vikings</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Chicago Bears" id="team-bears"> Chicago Bears</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Detroit Lions" id="team-lions"> Detroit Lions</label>
                                </ul>
                            </div>

                            <div>
                                <h4>NFC South</h4>
                                <ul class="team-list">
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Tampa Bay Buccaneers" id="team-buccaneers"> Tampa Bay Buccaneers</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="New Orleans Saints" id="team-saints"> New Orleans Saints</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Atlanta Falcons" id="team-falcons"> Atlanta Falcons</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Carolina Panthers" id="team-panthers"> Carolina Panthers</label>
                                </ul>
                            </div>

                            <div>
                                <h4>NFC West</h4>
                                <ul class="team-list">
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="San Francisco 49ers" id="team-49ers"> San Francisco 49ers</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Seattle Seahawks" id="team-seahawks"> Seattle Seahawks</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Los Angeles Rams" id="team-rams"> Los Angeles Rams</label>
                                    <label><input type="radio" class="form-check-input me-2" name="team" value="Arizona Cardinals" id="team-cardinals"> Arizona Cardinals</label>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button type="submit" id="teamBut" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>

            <!--Personalization Div-->
            <div class="p-4 h-100 d-none option-pane" id="personalizationDiv" style="border: 1px solid white; border-radius: 10px;">
                <form class="mt-4">
                    <div class="row g-3 align-items-center">
                        <label for="personalInput" class="col-lg-1 col-form-label">Label</label>
                        <div class="col-lg-11">
                            <input type="text" class="form-control" id="personalInput" required>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button type="submit" id="personBut" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
      </div>
    </main>
    <pre id="out"></pre>
    <script>

        // Dom Vars
        // Nav
        const dropEl = document.getElementById('user-dropdown');
        const nav = document.getElementById('nav');
        const logNavs = document.querySelectorAll('.log');
        // Nav items that get Changed
        const change1 = document.getElementById('change1');
        const change2 = document.getElementById('change2');
        const dropToggle = document.getElementById('user-btn');
        const user = document.getElementById('user');

        // Swap Divs and Their Activation Buttons
        const profBtn = document.getElementById('prof');
        const profDiv = document.getElementById('options');
        const teamBtn = document.getElementById('team');
        const teamDiv = document.getElementById('teamDiv');
        const personBtn = document.getElementById('person');
        const personDiv = document.getElementById('personalizationDiv');
        const logOut = document.getElementById('logout');

        // Save buttons
        const profSave = document.getElementById('optnBtn');
        const teamSave = document.getElementById('teamBut');
        const personSave = document.getElementById('personBut');

        let divState = "";

        //Helpers
        const clearInputs = (entry) => {
            if (!entry) return;
            entry.querySelectorAll('input, textarea, select').forEach((el) => {
            if (el.type === 'checkbox' || el.type === 'radio') {
                el.checked = false;
            } else {
                el.value = '';
            }
            });
        };

        (async () => {
            try {
            const res = await fetch('/api/me', { credentials: 'include' });
            if (!res.ok) throw new Error('not logged in');
            const data = await res.json();

            user.textContent = data?.username || '';
            
            if (dropEl) dropEl.style.display = 'block';

            if (data.preferences?.team) {
                const teamRes = await fetch(`/api/team/${encodeURIComponent(data.preferences.team)}`, { credentials: 'include' });
                if (teamRes.ok) {
                const team = await teamRes.json();
                const color = team?.colors?.[0];
                if (color) {
                    nav.style.background = `linear-gradient(to bottom, ${color}, rgba(0,0,0,0))`;
                }
                }
            }
            // Leave the default nav (Dashboard/News/Teams...) when logged in.
            } catch (err) {
            // User is not logged in: hide gated nav items and show login/signup links.
            logNavs.forEach(el => el.textContent = '');
            change1.textContent = 'Login';
            change1.href = '/login';
            change2.textContent = 'Sign Up';
            change2.href = '/signup';
            if (dropEl) dropEl.style.display = 'none';
            }
        })();

        // dropdown toggle

        if (dropToggle && dropEl) {
            dropToggle.addEventListener('click', (e) => {
            e.preventDefault();
            dropEl.classList.toggle('open');
            });
            document.addEventListener('click', (e) => {
            if (!dropEl.contains(e.target)) {
                dropEl.classList.remove('open');
            }
            });
        }

        // Show prof div
        if (profBtn && profDiv) {
            profBtn.addEventListener('click', () => {
            profDiv.classList.remove('d-none');
            teamDiv.classList.add('d-none');
            personDiv.classList.add('d-none');
            clearInputs(teamDiv);
            clearInputs(personDiv);
            divState = "prof";
            });
        }

        // Show team div
        if (teamBtn && teamDiv) {
            teamBtn.addEventListener('click', () => {
                teamDiv.classList.remove('d-none');
                profDiv.classList.add('d-none');
                personDiv.classList.add('d-none');
                clearInputs(profDiv);
                clearInputs(personDiv);
                divState = "team";
            });
        }

        // Show person div
        if (personBtn && personDiv) {
            personBtn.addEventListener('click', () => {
                personDiv.classList.remove('d-none');
                teamDiv.classList.add('d-none');
                profDiv.classList.add('d-none');
                clearInputs(profDiv);
                clearInputs(teamDiv);
                divState = "person";
            })
        }

        // Logout button
        if (logOut) {
            logOut.addEventListener('click', () => {
                personDiv.classList.add('d-none');
                teamDiv.classList.add('d-none');
                profDiv.classList.add('d-none');
                clearInputs(personDiv);
                clearInputs(profDiv);
                clearInputs(teamDiv);
                fetch("/logout", { method: "GET", credentials: "include" })
                .finally(() => {
                    window.location.href = "/";
                });
            });
        }

        //Form submissions

        //Option submit
        const optionsForm = document.getElementById('options-form');
        if (optionsForm) {
            optionsForm.addEventListener('submit', async (e) => {
                if (divState == "prof") {
                    e.preventDefault();
                    const usernameInput = document.getElementById('optionUsername');
                    const username = usernameInput ? usernameInput.value.trim() : "";

                    const res = await fetch('/api/updateUsr', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username }),
                        credentials: 'include'
                    });

                    if (res.ok) {
                        document.getElementById('out').textContent = 'Username updated.';
                    } else {
                        const data = await res.json().catch(() => ({}));
                        document.getElementById('out').textContent = data.error || 'Update failed.';
                    }
                    
                    //cleanup
                    clearInputs(profDiv);
                    window.location.href = "/settings"
                }
            });
        }

        // Team Submit
        document.getElementById('altTeam').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const team = formData.get('team');

            if (!team) {
                document.getElementById('out').textContent = 'Please select a team before saving.';
                return;
            }

            const response = await fetch("/api/preferences", {
                method: "post",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ preferences: { team } }),
                credentials: 'include'
            });

            let result = {};
            try {
              result = await response.json();
            } catch (err) {
              document.getElementById('out').textContent = 'An error occurred. Please try again.';
              return;
            }

            if (response.ok) {
                document.getElementById('out').textContent = 'Team preference saved successfully!';
                window.location.href = '/';
            } else {
                document.getElementById('out').textContent = result.error || 'An error occurred. Please try again.';
            }
        });


    </script>
  </body>
</html>
